# OpenResty/nginx configuration for secure reverse proxy
# Generated by sm proxy - DO NOT EDIT MANUALLY
# Regenerate with: sm proxy reload

worker_processes {{ worker_processes }};
error_log /var/log/sm/proxy-error.log warn;
pid /run/openresty.pid;

events {
    worker_connections {{ worker_connections }};
    use epoll;
    multi_accept on;
}

http {
    include /etc/openresty/mime.types;
    default_type application/octet-stream;

    # Lua paths
    lua_package_path "/etc/openresty/lua/?.lua;;";

    # Shared dictionaries for rate limiting and API keys
    lua_shared_dict rate_limit 10m;
    lua_shared_dict api_keys 1m;

    # Declare api_key_name variable (can be overwritten by Lua in server blocks)
    map $uri $api_key_name {
        default "-";
    }

    # Load API keys on startup
    init_by_lua_file /etc/openresty/lua/init.lua;

    # JSON structured logging
    log_format json_combined escape=json '{'
        '"time":"$time_iso8601",'
        '"remote_addr":"$remote_addr",'
        '"method":"$request_method",'
        '"uri":"$uri",'
        '"status":$status,'
        '"body_bytes_sent":$body_bytes_sent,'
        '"request_time":$request_time,'
        '"upstream_response_time":"$upstream_response_time",'
        '"http_user_agent":"$http_user_agent",'
        '"api_key_name":"$api_key_name"'
    '}';

    access_log /var/log/sm/proxy-access.log json_combined;

    # Security headers
    server_tokens off;
    # Note: Use 'more_clear_headers "Server"' if ngx_headers_more module is available

    # Performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Timeouts
    proxy_connect_timeout {{ proxy_connect_timeout }};
    proxy_read_timeout {{ proxy_read_timeout }};
    proxy_send_timeout {{ proxy_read_timeout }};

    # Body size limit
    client_max_body_size {{ client_max_body_size }};

    # Buffer settings for proxying
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;

    # gRPC settings
    grpc_buffer_size 4k;
    grpc_read_timeout {{ proxy_read_timeout }};
    grpc_send_timeout {{ proxy_read_timeout }};

{% if endpoints %}
{% for endpoint in endpoints %}
    # =========================================================================
    # Endpoint: {{ endpoint.name }}
    # Protocol: {{ endpoint.protocol | default('http') }}
    # Upstream: {{ endpoint.upstream }}
    # =========================================================================

    upstream {{ endpoint.name }}_backend {
        server {{ endpoint.upstream }};
        keepalive 32;
    }

    server {
        listen {{ endpoint.listen_port }}{% if endpoint.protocol == 'grpc' %} http2{% endif %};
        server_name _;

        # Variable for logging API key name
        set $api_key_name "-";

{% if endpoint.require_auth | default(true) %}
        # API Key authentication
        access_by_lua_file /etc/openresty/lua/auth.lua;
{% endif %}

{% if endpoint.allowed_methods %}
        # Method restriction
        if ($request_method !~ ^({{ endpoint.allowed_methods | join('|') }})$) {
            return 405;
        }
{% endif %}

        location / {
{% if endpoint.protocol == 'grpc' %}
            # gRPC proxy
            grpc_pass grpc://{{ endpoint.name }}_backend;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            grpc_set_header X-Forwarded-Proto $scheme;

            # Handle gRPC errors
            error_page 502 = /grpc_error_502;
            error_page 503 = /grpc_error_503;
            error_page 504 = /grpc_error_504;
{% else %}
            # HTTP proxy
            proxy_pass http://{{ endpoint.name }}_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";

            # Disable buffering for streaming
            proxy_buffering off;
            proxy_request_buffering off;
{% endif %}
        }

        # Health check endpoint (no auth required)
        location {{ endpoint.health_check_path | default('/health') }} {
            access_log off;
{% if endpoint.require_auth | default(true) %}
            # Skip auth for health checks - use location-specific Lua to bypass
            access_by_lua_block {
                ngx.var.api_key_name = "health_check"
            }
{% endif %}
            default_type application/json;
            return 200 '{"status":"ok","endpoint":"{{ endpoint.name }}"}';
        }

{% if endpoint.protocol == 'grpc' %}
        # gRPC error handlers
        location = /grpc_error_502 {
            internal;
            default_type application/grpc;
            add_header grpc-status 14;
            add_header grpc-message "upstream unavailable";
            return 204;
        }

        location = /grpc_error_503 {
            internal;
            default_type application/grpc;
            add_header grpc-status 14;
            add_header grpc-message "service unavailable";
            return 204;
        }

        location = /grpc_error_504 {
            internal;
            default_type application/grpc;
            add_header grpc-status 4;
            add_header grpc-message "deadline exceeded";
            return 204;
        }
{% endif %}
    }

{% endfor %}
{% else %}
    # No endpoints configured - proxy is in standby mode
    # Use: sm proxy endpoint add --name <name> --listen-port <port> --upstream <host:port>
    # Note: No server blocks defined until endpoints are added to avoid port conflicts
{% endif %}
}
