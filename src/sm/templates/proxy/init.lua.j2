-- /etc/openresty/lua/init.lua
-- Initialize API keys in shared dictionary
-- Generated by sm proxy - DO NOT EDIT MANUALLY

local cjson = require "cjson.safe"

-- API keys loaded from configuration (stored as JSON string, decoded at runtime)
-- Format: { "sk_live_xxx": { "name": "...", "endpoints": [...], "rate_limit": N, ... } }
local keys_json = [==[{{ keys }}]==]

-- Load keys into shared dictionary
local function load_keys()
    local keys_dict = ngx.shared.api_keys

    -- Clear existing keys
    keys_dict:flush_all()
    keys_dict:flush_expired()

    -- Parse JSON string into Lua table
    local keys_data, err = cjson.decode(keys_json)
    if not keys_data then
        ngx.log(ngx.ERR, "Failed to parse API keys JSON: ", err)
        return
    end

    local count = 0
    for key, data in pairs(keys_data) do
        local json_data = cjson.encode(data)
        local success, set_err = keys_dict:set(key, json_data)
        if not success then
            ngx.log(ngx.ERR, "Failed to load API key '", data.name, "': ", set_err)
        else
            count = count + 1
        end
    end

    ngx.log(ngx.NOTICE, "Loaded ", count, " API keys into shared dictionary")
end

-- Execute on nginx startup
load_keys()
