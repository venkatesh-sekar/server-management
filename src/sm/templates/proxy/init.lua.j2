-- /etc/openresty/lua/init.lua
-- Initialize API keys in shared dictionary
-- Generated by sm proxy - DO NOT EDIT MANUALLY

local cjson = require "cjson.safe"

-- API keys loaded from configuration
-- Format: { "sk_live_xxx": { name: "...", endpoints: [...], rate_limit: N, ... } }
local keys_data = {{ keys }}

-- Load keys into shared dictionary
local function load_keys()
    local keys_dict = ngx.shared.api_keys

    -- Clear existing keys
    keys_dict:flush_all()
    keys_dict:flush_expired()

    local count = 0
    for key, data in pairs(keys_data) do
        local json_data = cjson.encode(data)
        local success, err = keys_dict:set(key, json_data)
        if not success then
            ngx.log(ngx.ERR, "Failed to load API key '", data.name, "': ", err)
        else
            count = count + 1
        end
    end

    ngx.log(ngx.NOTICE, "Loaded ", count, " API keys into shared dictionary")
end

-- Execute on nginx startup
load_keys()
