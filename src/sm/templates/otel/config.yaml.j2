# OpenTelemetry Collector Configuration
# Generated by sm observability setup

receivers:
  hostmetrics:
    collection_interval: {{ collection_interval }}
    scrapers:
      cpu: {}
      load: {}
      memory: {}
      network: {}
      paging: {}
      disk: {}
      processes: {}
      filesystem:
        # Include all real devices
        include_devices:
          devices: [".+"]
          match_type: regexp

        # Exclude noisy / ephemeral mount points
        exclude_mount_points:
          mount_points:
            - "/proc.*"
            - "/sys.*"
            - "/run/user.*"
            - "/run/containerd.*"
            - "/var/lib/docker.*"
            - "/snap.*"
          match_type: regexp

        # Exclude virtual / pseudo FS types
        exclude_fs_types:
          fs_types:
            - "sysfs"
            - "proc"
            - "tmpfs"
            - "devtmpfs"
            - "devfs"
            - "overlay"
            - "squashfs"
          match_type: strict

        # Keep only "real" filesystems
        include_virtual_filesystems: false

{% if collect_logs %}
  filelog/fail2ban:
    include: ["/var/log/fail2ban.log"]
    start_at: end
    include_file_path: true
    operators:
      - type: add
        field: attributes.log_type
        value: fail2ban

  filelog/auth:
    include: ["/var/log/auth.log", "/var/log/secure"]
    start_at: end
    include_file_path: true
    operators:
      - type: add
        field: attributes.log_type
        value: auth

  filelog/audit:
    include: ["/var/log/audit/audit.log"]
    start_at: end
    include_file_path: true
    operators:
      - type: add
        field: attributes.log_type
        value: auditd
{% endif %}

processors:
  resourcedetection:
    detectors: [system, env{% if enable_cloud_detection %}, gcp, ec2{% endif %}]
    system:
      hostname_sources: [os]
  batch: {}

exporters:
  otlphttp:
    endpoint: "{{ otlp_endpoint }}"
    compression: gzip
    timeout: 30s

service:
  pipelines:
    metrics:
      receivers: [hostmetrics]
      processors: [resourcedetection, batch]
      exporters: [otlphttp]
{% if collect_logs %}
    logs:
      receivers: [filelog/fail2ban, filelog/auth, filelog/audit]
      processors: [resourcedetection, batch]
      exporters: [otlphttp]
{% endif %}
