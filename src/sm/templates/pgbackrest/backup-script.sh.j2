#!/usr/bin/env bash
# pgBackRest backup wrapper script
# Generated by sm postgres setup
set -euo pipefail

STANZA="{{ stanza }}"
LOG_DIR="/var/log/pgbackrest"
mkdir -p "$LOG_DIR"

run_backup() {
  local type="$1"
  local now
  now="$(date +'%Y-%m-%d %H:%M:%S')"

  local logfile="${LOG_DIR}/backup-${type}.log"

  echo "[$now] Starting ${type} backup" >> "$logfile"

  pgbackrest --stanza="$STANZA" --type="$type" --log-level-console=info backup >> "$logfile" 2>&1

  now="$(date +'%Y-%m-%d %H:%M:%S')"
  echo "[$now] Completed ${type} backup" >> "$logfile"
}

case "${1:-}" in
  hourly)
    run_backup incr
    ;;
  daily)
    run_backup diff
    ;;
  weekly)
    run_backup full
    ;;
  *)
    echo "Usage: $0 {hourly|daily|weekly}" >&2
    exit 1
    ;;
esac
